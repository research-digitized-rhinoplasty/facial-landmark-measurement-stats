<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    #stats-table,
    #measurement-table {
      margin-top: 20px;
    }
    .button-row {
      margin: 10px 0;
    }
    /* style for the checkbox container */
    .header-multicheck {
      max-height: 180px;
      overflow-y: auto;
      padding: 4px;
      background: white;
      border: 1px solid #ccc;
    }
    .header-multicheck label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
      cursor: pointer;
    }
    .header-multicheck input {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <h2>3D Facial Landmark Query Tool</h2>

  <div class="button-row">
    <button id="clearFilters">Clear All Column Filters</button>
  </div>

  <!-- Stats Table -->
  <div id="stats-table"></div>

  <!-- Measurements Table -->
  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script>
    // exact-match helper
    function exactMatch(headerValue, rowValue) {
      return headerValue === "All" ||
             headerValue === "Any" ||
             rowValue === headerValue;
    }

    // 1) checkbox-based multi-select editor
    function checkboxHeaderFilter(cell, onRendered, success) {
      const values = cell.getColumn().getDefinition().headerFilterParams.values;
      const container = document.createElement("div");
      container.classList.add("header-multicheck");

      values.forEach(val => {
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = val;
        label.appendChild(cb);
        label.appendChild(document.createTextNode(val));
        container.appendChild(label);

        // on change, collect all checked and call success
        cb.addEventListener("change", () => {
          const chosen = Array.from(container.querySelectorAll("input:checked"))
                              .map(i => i.value);
          success(chosen);
        });
      });

      // ensure the container is focusable so Tabulator doesn't immediately close it
      container.tabIndex = 0;
      onRendered(() => container.focus());

      return container;
    }

    // 2) filter function for arrays
    function multiSelectFilterFunc(filterValues, cellValue) {
      if (!filterValues || filterValues.length === 0) return true;
      return filterValues.includes(cellValue);
    }

    fetch('data.json')
      .then(r => {
        if (!r.ok) throw new Error("data.json not found");
        return r.json();
      })
      .then(participants => {
        // flatten measurements
        const allMeasurements = participants.flatMap(p =>
          (p.ParticipantMeasurements || []).map(m => ({
            participantFileId: p.participantFileId,
            measurementName: m.MeasurementName,
            value: m.Value,
          }))
        );

        // measurements table
        const measurementTable = new Tabulator("#measurement-table", {
          data: allMeasurements,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID", field: "participantFileId" },
            { title: "Measurement Name", field: "measurementName" },
            { title: "Value", field: "value" },
          ],
        });

        // stats table
        const statsTable = new Tabulator("#stats-table", {
          data: participants,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID", field: "participantFileId" },

            // Gender
            {
              title: "Gender",
              field: "Gender",
              headerFilter: checkboxHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: { values: ["M", "F", "Other"] }
            },

            // Age Min
            {
              title: "Age Min",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Min…",
              headerFilterFunc: ">=",
              headerFilterLiveFilter: true,
            },
            // Age Max
            {
              title: "Age Max",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Max…",
              headerFilterFunc: "<=",
              headerFilterLiveFilter: true,
            },

            // Ethnicity
            {
              title: "Ethnicity",
              field: "Ethnicity",
              headerFilter: checkboxHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: {
                values: [
                  "White",
                  "Black or African American",
                  "American Indian or Alaska Native",
                  "Asian",
                  "Native Hawaiian or Other Pacific Islander",
                  "Hispanic",
                  "Prefer not to specify"
                ]
              }
            },

            // Facial Surgery
            {
              title: "Facial Surgery",
              field: "FacialSurgery",
              headerFilter: checkboxHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: {
                values: [
                  "No Facial Surgery",
                  "Brow/forehead lift",
                  "Ear Pinning",
                  "Chin, cheek, or jaw reshaping",
                  "Eyelid Lift",
                  "Facelift",
                  "Facial implants",
                  "Hair Replacement surgery",
                  "Lip Augmentation",
                  "Rhinoplasty",
                  "Other",
                  "Prefer not to specify"
                ]
              }
            },
          ],
        });

        // sync measurements
        statsTable.on("dataFiltered", (filters, rows) => {
          const ids = rows.map(r => r.getData().participantFileId);
          measurementTable.replaceData(
            allMeasurements.filter(m => ids.includes(m.participantFileId))
          );
        });

        // clear filters
        document.getElementById("clearFilters")
                .addEventListener("click", () => statsTable.clearHeaderFilter());
      })
      .catch(err => {
        console.error(err);
        document.getElementById("stats-table").innerHTML =
          `<p style="color:red;">${err.message}</p>`;
      });
  </script>
</body>
</html>
