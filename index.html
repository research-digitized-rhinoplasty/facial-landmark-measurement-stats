<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    #stats-table, #measurement-table, #landmark-table { margin-top: 20px; }
    .button-row { margin: 10px 0; }

    /* Allow header filters to overflow */
    .tabulator .tabulator-header {
      overflow: visible !important;
    }
    .tabulator .tabulator-header .tabulator-col {
      overflow: visible !important;
      position: relative !important;
    }
    .tabulator .tabulator-header .tabulator-col .tabulator-header-filter {
      overflow: visible !important;
      position: relative !important;
    }

    /* Dropdown checkbox list styles */
    .checkbox-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 9999;
      background: white;
      border: 1px solid #ccc;
      max-height: 180px;
      overflow-y: auto;
      padding: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .checkbox-dropdown label {
      display: block;
      font-size: 12px;
      cursor: pointer;
      margin-bottom: 2px;
    }
    .checkbox-dropdown input {
      margin-right: 6px;
    }
    .dropdown-toggle {
      cursor: pointer;
      padding: 4px;
      border: 1px solid #ccc;
      background: #fff;
      width: 100%;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h2>3D Facial Landmark Query Tool</h2>
  <div class="button-row">
    <button id="clearFilters">Clear All Filters</button>
    <button id="downloadCSV">Download Filtered Data (CSV)</button>
    <button id="showChartBtn">Show Chart</button>
  </div>
  <div id="chart-controls" style="display:none; border:1px solid #ccc; padding:10px; margin-bottom:10px;">
    <div><strong>Group by:</strong>
      <label><input type="radio" name="group" value="gender" checked/> Gender</label>
      <label><input type="radio" name="group" value="ethnicity"/> Ethnicity</label>
      <label><input type="radio" name="group" value="surgery"/> Facial Surgery</label>
      <label><input type="radio" name="group" value="age"/> Age</label>
    </div>
    <div style="margin-top:5px;"><strong>Chart Type:</strong>
      <label><input type="radio" name="chartType" value="bar" checked/> Bar</label>
      <label><input type="radio" name="chartType" value="pie"/> Pie</label>
    </div>
  </div>

  <!-- Stats Table -->
  <div id="stats-table"></div>

  <!-- Measurements Table -->
  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <!-- Landmarks Table -->
  <h2>Landmarks</h2>
  <div id="landmark-table"></div>

  <!-- Chart Canvas -->
  <canvas id="stats-chart" style="max-width:600px; display:none; margin-top:20px;"></canvas>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script>
    // exact-match helper
    function exactMatch(h, v) {
      return h === "All" || h === "Any" || v === h;
    }

    // dropdown checkbox header filter
    function dropdownMultiCheck(cell, onRendered, success) {
      const column = cell.getColumn();
      const field = column.getField();
      const table = cell.getTable();
      const values = column.getDefinition().headerFilterParams.values;
      const toggle = document.createElement('div');
      toggle.classList.add('dropdown-toggle');
      const updateLabel = () => {
        const current = table.getHeaderFilterValue(field) || [];
        toggle.textContent = current.length ? current.join(', ') : 'Select...';
      };
      updateLabel();
      let list;
      const openDropdown = () => {
        if (list) return;
        list = document.createElement('div');
        list.classList.add('checkbox-dropdown');
        const current = table.getHeaderFilterValue(field) || [];
        values.forEach(val => {
          const lbl = document.createElement('label');
          const cb  = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = val;
          cb.checked = current.includes(val);
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(val));
          list.appendChild(lbl);
          cb.addEventListener('change', () => {
            const chosen = Array.from(list.querySelectorAll('input:checked')).map(i => i.value);
            success(chosen);
            toggle.textContent = chosen.length ? chosen.join(', ') : 'Select...';
          });
        });
        document.body.appendChild(list);
        const rect = toggle.getBoundingClientRect();
        list.style.top = rect.bottom + window.scrollY + 'px';
        list.style.left = rect.left + window.scrollX + 'px';
        document.addEventListener('click', outsideClick);
      };
      const closeDropdown = () => { list && list.remove(); list = null; document.removeEventListener('click', outsideClick); };
      const outsideClick = (e) => { if (!toggle.contains(e.target) && list && !list.contains(e.target)) closeDropdown(); };
      toggle.addEventListener('click', e => { e.stopPropagation(); list ? closeDropdown() : openDropdown(); });
      onRendered(() => {});
      return toggle;
    }

    function multiSelectFilterFunc(filterVals, cellVal) {
      return !filterVals || !filterVals.length || filterVals.includes(cellVal);
    }

    fetch('data.json')
      .then(r => r.ok ? r.json() : Promise.reject('data.json not found'))
      .then(participants => {
        const allMeasurements = participants.flatMap(p => (p.ParticipantMeasurements||[]).map(m => ({ participantFileId: p.participantFileId, measurementName: m.MeasurementName, value: m.Value })));
        const allLandmarks    = participants.flatMap(p => (p.ParticipantLandmarks||[]).map(l => ({ participantFileId: p.participantFileId, landmarkName: l.LandmarkName, xVal: l.xVal, yVal: l.yVal, zVal: l.zVal })));

        const measurementTable = new Tabulator('#measurement-table', { /* same as before */ data:allMeasurements, layout:'fitColumns', pagination:'local', paginationSize:10, columns:[ /* ... */ ] });
        const landmarkTable    = new Tabulator('#landmark-table',    { /* same as before */ data:allLandmarks,    layout:'fitColumns', pagination:'local', paginationSize:10, columns:[ /* ... */ ] });

        const statsTable = new Tabulator('#stats-table', {
          data: participants,
          layout: 'fitColumns',
          pagination: 'local',
          paginationSize: 10,
          columns: [
            { title: 'Participant ID', field: 'participantFileId' },
            { title: 'Gender',         field: 'Gender',        headerFilter: dropdownMultiCheck, headerFilterFunc: multiSelectFilterFunc, headerFilterParams:{ values:['M','F','Other'] } },
            { title: 'Age Min',        field: 'Age',           sorter:'number', headerFilter:'input', headerFilterPlaceholder:'Min…', headerFilterFunc:'>=', headerFilterLiveFilter:true },
            { title: 'Age Max',        field: 'Age',           sorter:'number', headerFilter:'input', headerFilterPlaceholder:'Max…', headerFilterFunc:'<=', headerFilterLiveFilter:true },
            { title: 'Ethnicity',      field: 'Ethnicity',     headerFilter: dropdownMultiCheck, headerFilterFunc: multiSelectFilterFunc, headerFilterParams:{ values:['White','Black or African American','American Indian or Alaska Native','Asian','Native Hawaiian or Other Pacific Islander','Hispanic','Prefer not to specify'] } },
            { title: 'Facial Surgery', field: 'FacialSurgery', headerFilter: dropdownMultiCheck, headerFilterFunc: multiSelectFilterFunc, headerFilterParams:{ values:['No Facial Surgery','Brow/forehead lift','Ear pinning','Chin, cheek, or jaw reshaping','Eyelid lift','Facelift','Facial implants','Hair replacement surgery','Lip augmentation','Rhinoplasty','Other','Prefer not to specify'] } },
          ],
        });

        // Chart elements
        const showChartBtn  = document.getElementById('showChartBtn');
        const controlsDiv   = document.getElementById('chart-controls');
        const canvas        = document.getElementById('stats-chart');
        let statsChart;

        showChartBtn.addEventListener('click', () => {
          controlsDiv.style.display = 'block';
          canvas.style.display = 'block';
          if (!statsChart) initChart();
          updateChart();
        });

        document.querySelectorAll('input[name="group"], input[name="chartType"]').forEach(el => el.addEventListener('change', updateChart));

        statsTable.on('dataFiltered', (filters, rows) => {
          const ids = rows.map(r => r.getData().participantFileId);
          measurementTable.replaceData(allMeasurements.filter(m => ids.includes(m.participantFileId)));
          landmarkTable.replaceData(allLandmarks.filter(l => ids.includes(l.participantFileId)));
          if (statsChart && controlsDiv.style.display === 'block') updateChart();
        });

        function initChart() {
          const ctx = canvas.getContext('2d');
          statsChart = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [{ label: '%', data: [] }] }, options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } } });
        }

        function updateChart() {
          const group = document.querySelector('input[name="group"]:checked').value;
          const type  = document.querySelector('input[name="chartType"]:checked').value;
          const data  = statsTable.getData();
          const counts = {};

          data.forEach(r => {
            let key;
            if (group === 'gender')    key = r.Gender;
            else if (group === 'ethnicity') key = r.Ethnicity;
            else if (group === 'surgery')   key = r.FacialSurgery;
            else if (group === 'age')       key = String(r.Age);
            counts[key] = (counts[key] || 0) + 1;
          });

          const total = data.length || 1;
          const labels = Object.keys(counts).sort((a, b) => group === 'age' ? a - b : a.localeCompare(b));
          const values = labels.map(l => (counts[l] / total * 100).toFixed(2));

          statsChart.config.type = type;
          statsChart.data.labels = labels;
          statsChart.data.datasets = [{ label: '%', data: values }];
          statsChart.update();
        }

      })
      .catch(err => { console.error(err); document.querySelector('#stats-table').innerHTML = `<p style="color:red">${err}</p>`; });

    // CSV download
    function downloadAllFilteredData() {
      const allData = [...statsTable.getData(), ...measurementTable.getData(), ...landmarkTable.getData()];
      const headers = new Set(); allData.forEach(row => Object.keys(row).forEach(k => headers.add(k)));
      const headerArray = Array.from(headers);
      const csvRows = [headerArray.join(',')];
      allData.forEach(row => {
        const line = headerArray.map(f => row[f] !== undefined ? `"${String(row[f]).replace(/"/g, '""')}"` : '').join(',');
        csvRows.push(line);
      });
      const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
      link.setAttribute('download', 'filtered_data.csv'); document.body.appendChild(link); link.click(); link.remove();
    }
    document.getElementById('downloadCSV').addEventListener('click', downloadAllFilteredData);
  </script>
</body>
</html>
