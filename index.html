<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />

  <style>
    body { font-family: Arial; padding: 20px; }
    #participants-table, #measurement-table, #landmark-table { margin-top: 20px; }
    .button-row { margin: 10px 0; }

    /* Hide chart container until 'Chart' is clicked */
    #chart-container {
        display: none;
        margin: 0 auto;
        padding: 10px;
        max-width: 700px;
        text-align: center;
    }

    /* Chart canvas styling */
    #chart-canvas {
        max-width: 100%;
        max-height: 400px;
    }

    /* Allow header filters to overflow */
    .tabulator .tabulator-header { overflow: visible !important; }
    .tabulator .tabulator-header .tabulator-col { overflow: visible !important; position: relative !important; }
    .tabulator .tabulator-header .tabulator-col .tabulator-header-filter { overflow: visible !important; position: relative !important; }

    /* Dropdown checkbox list styles */
    .checkbox-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 9999;
      background: white;
      border: 1px solid #ccc;
      max-height: 180px;
      overflow-y: auto;
      padding: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .checkbox-dropdown label { display: block; font-size: 12px; cursor: pointer; margin-bottom: 2px; }
    .checkbox-dropdown input { margin-right: 6px; }
    .dropdown-toggle { cursor: pointer; padding: 4px; border: 1px solid #ccc; background: #fff; width: 100%; box-sizing: border-box; }

    /* Chart options styling */
    #chart-options { border: 1px solid #ccc; padding: 10px; max-width: 400px; }
    #chart-options label { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>3D Facial Landmark Query Tool</h2>
  <div class="button-row">
    <button id="clearFilters">Clear All Filters</button>
    <button id="downloadCSV">Download Data</button>
    <button id="create-chart">Chart</button>
  </div>

  <h2>Participant Information</h2>
  <div id="participants-table"></div>

  <!-- Chart container hidden until Chart button clicked -->
  <div id="chart-container">
    <fieldset id="chart-options">
      <legend>Category</legend>
      <label><input type="radio" name="category" value="Ethnicity" checked> Ethnicity</label>
      <label><input type="radio" name="category" value="Gender"> Gender</label>
      <label><input type="radio" name="category" value="FacialSurgery"> Facial Surgery</label>
      <label><input type="radio" name="category" value="Age"> Age</label>
      <br><br>
      <label><input type="radio" name="chartType" value="pie" checked> Pie</label>
      <label><input type="radio" name="chartType" value="bar"> Bar</label>
    </fieldset>
    <canvas id="chart-canvas"></canvas>
  </div>

  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <h2>Landmarks</h2>
  <div id="landmark-table"></div>

  <!-- ─────────────── STATISTICS CONTROLS & TABLE ─────────────── -->
  <div style="margin: 1em 0; display: flex; align-items: center; gap: 20px;">
    <fieldset id="stats-options" style="border: none; display: flex; align-items: center; gap: 10px; margin: 0;">
      <legend style="font-weight: bold; margin-right: 10px;">Show stats for:</legend>
      <label><input type="radio" name="statsType" value="measurements" checked> Measurements</label>
      <label><input type="radio" name="statsType" value="landmarks"> Landmarks</label>
    </fieldset>
    <button id="show-stats-button">Show Stats</button>
  </div>

  <!-- Initially hidden stats table -->
  <div id="stats-table-container" style="display: none;">
    <div id="stats-table"></div>
  </div>
  <!-- ───────────────────────────────────────────────────────────── -->


  <!-- Libraries -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // exact-match helper
    function exactMatch(h, v) { return h === "All" || h === "Any" || v === h; }

    // dropdown checkbox header filter
    function dropdownMultiCheck(cell, onRendered, success) {
      const column = cell.getColumn(), field = column.getField(), table = cell.getTable();
      const values = column.getDefinition().headerFilterParams.values;
      const toggle = document.createElement('div'); toggle.classList.add('dropdown-toggle');
      const updateLabel = () => {
        const current = table.getHeaderFilterValue(field) || [];
        toggle.textContent = current.length ? current.join(', ') : 'Select...';
      };
      updateLabel(); let list;
      const openDropdown = () => {
        if (list) return;
        list = document.createElement('div'); list.classList.add('checkbox-dropdown');
        const current = table.getHeaderFilterValue(field) || [];
        values.forEach(val => {
          const lbl = document.createElement('label');
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = val; cb.checked = current.includes(val);
          lbl.appendChild(cb); lbl.appendChild(document.createTextNode(val)); list.appendChild(lbl);
          cb.addEventListener('change', () => {
            const chosen = Array.from(list.querySelectorAll('input:checked')).map(i => i.value);
            success(chosen);
            toggle.textContent = chosen.length ? chosen.join(', ') : 'Select...';

            // Redraw chart immediately if it matches the selected category
            const category = document.querySelector('input[name="category"]:checked')?.value;
            const chartVisible = document.getElementById("chart-container").style.display !== "none";

            if (
              chartVisible &&
              (
                (category === "Age" && field === "Age") ||
                field?.toLowerCase().includes(category?.toLowerCase())
              )
            ) {
              drawChart();
            }
          });
        });
        document.body.appendChild(list);
        const rect = toggle.getBoundingClientRect();
        list.style.top = rect.bottom + window.scrollY + 'px'; list.style.left = rect.left + window.scrollX + 'px';
        document.addEventListener('click', outsideClick);
      };
      const closeDropdown = () => { if (list) { list.remove(); list = null; } document.removeEventListener('click', outsideClick); };
      const outsideClick = e => { if (!toggle.contains(e.target) && list && !list.contains(e.target)) closeDropdown(); };
      toggle.addEventListener('click', e => { e.stopPropagation(); list ? closeDropdown() : openDropdown(); });
      onRendered(() => {});
      return toggle;
    }
    function multiSelectFilterFunc(filterVals, cellVal) {
      if (!filterVals || !filterVals.length) return true;
      return filterVals.includes(cellVal);
    }

    let participantsTable, measurementTable, landmarkTable;
    let currentChart;

    fetch('data.json')
      .then(r => r.ok ? r.json() : Promise.reject('data.json not found'))
      .then(participants => {
        const allMeasurements = participants.flatMap(p =>
          (p.ParticipantMeasurements || []).map(m => ({
            participantFileId: p.participantFileId,
            measurementName: m.MeasurementName,
            value: m.Value
          }))
        );

        const allLandmarks = participants.flatMap(p =>
          (p.ParticipantLandmarks || []).map(l => ({
            participantFileId: p.participantFileId,
            landmarkName: l.LandmarkName,
            xVal: l.xVal,
            yVal: l.yVal,
            zVal: l.zVal
          }))
        );

        measurementTable = new Tabulator('#measurement-table', {
  data: allMeasurements,
  layout: 'fitColumns',
  pagination: 'local',
  paginationSize: 10,
  columns: [
    { title: 'Participant ID', field: 'participantFileId' },
    {
      title: 'Measurement Name',
      field: 'measurementName',
      headerFilter: dropdownMultiCheck,
      headerFilterFunc: multiSelectFilterFunc,
      headerFilterParams: {
        values: [
          "(Inner) Intercanthal Distance/Width", "Ala/Alar Length (left)", "Ala/Alar Length (right)", "Alar Base Width", "Base Bony Width",
          "Columella Length", "Columella Width", "Distance between sill-base junction and alar flare", "Distance between 1st point - 2nd point",
          "Eye/palpebral fissure length - left", "Eye/palpebral fissure length - right", "Face Width", "Infratip Lobule Length", "Interalar Distance",
          "Lower Facial Height", "Mid-Facial Height", "Nasal Bridge Length", "Nasal Root Width", "Nasal Tip Projection", "Nose Height",
          "Nostril Floor Width (left)", "Nostril Floor Width (right)", "Outer Intercanthal Distance", "Premaxilla - left", "Premaxilla - right",
          "Radix Projection", "Subnasal Width", "Supratip Lobule", "Tip/Lobule Width", "Upper Facial Height",
          "Distances - Surface", "(Inner) Intercanthal Distance/Width - Surface", "Ala/Alar Length (left) - Surface", "Ala/Alar Length (right) - Surface",
          "Alar Base Width - Surface", "Base Bony Width - Surface", "Columella Length - Surface", "Columella Width - Surface",
          "Distance between sill-base junction and alar flare - Surface", "Distance between 1st point - 2nd point - Surface",
          "Eye/palpebral fissure length - left - Surface", "Eye/palpebral fissure length - right - Surface", "Face Width - Surface",
          "Infratip Lobule Length - Surface", "Interalar Distance - Surface", "Lower Facial Height - Surface", "Mid-Facial Height - Surface",
          "Nasal Bridge Length - Surface", "Nasal Root Width - Surface", "Nasal Tip Projection - Surface", "Nose Height - Surface",
          "Nostril Floor Width (left) - Surface", "Nostril Floor Width (right) - Surface", "Outer Intercanthal Distance - Surface",
          "Premaxilla - left - Surface", "Premaxilla - right - Surface", "Radix Projection - Surface", "Subnasal Width - Surface",
          "Supratip Lobule - Surface", "Tip/Lobule Width - Surface", "Upper Facial Height - Surface",
          "Angles", "Columellar Labial Angle", "Columellar Lobular Angle", "Degree of Deviation (I-type)", "Domal divergence",
          "Interalar Angle", "Medium facial third angle - right", "Nasal Tip Angle", "Nasofacial Angle", "Nasofrontal Angle", "Nasolabial Angle I",
          "Nasolabial contour", "Nasomental Angle I", "Rhinion deviation angle", "Supratip Deviation Angle", "Tip deviation angle",
          "Ratios", "Ratio: Symmetry - Alar Base (Right) to Nasion to Alar Base (Left)", "Ratio: Symmetry - Alar Base (Right) to Pronasale to Alar Base (Left)",
          "Ratio: Symmetry - Alar Base (Right) to Subnasale to Alar Base (Left)", "Lobule - Base Ratio", "Nasal Tip Projection: Baum",
          "Nasal Tip Projection: Byrd and Hobar", "Nasal Tip Projection: Goode", "Nasal Tip Projection: Goode (Left)",
          "Nasal Tip Projection: Goode (Right)", "Nasal Tip Projection: Powell and Humphries", "Nasal Tip Projection: Simons",
          "Nasal Width-Length Ratio", "Nasal Width–Intercanthal Distance Ratio", "Ratio: Nasion to Labiale Superios to Alar Base (Left)",
          "Ratio: Nasion to Labiale Superios to Alar Base (Right)", "Ratio: Nasion to Labiale Superios to Alar Rim’s Highest Point (left)",
          "Ratio: Nasion to Labiale Superios to Alar Rim’s Highest Point (right)", "Ratio: Nasion to Subnasale to Alar Base (Left)",
          "Ratio: Nasion to Subnasale to Alar Base (Right)", "Ratio: Nasion to Subnasale to Alar Rim’s Highest Point (left)",
          "Ratio: Nasion to Subnasale to Alar Rim’s Highest Point (right)",
          "Areas - Surface", "Alar Base Area", "Dorsal Hump Area", "Area of Entire Nose", "Nasal Dorsum Area", "Root of the Nose Area",
          "Tip Surface Area", "Area between the vertical fifths and horizontal thirds",
          "Volumes", "Alar Base Volume", "Dorsal Hump Volume", "Volume of Entire Nose", "Nasal Dorsum Volume", "Root of the Nose Volume",
          "Tip Volume", "Volume between the vertical fifths and horizontal thirds"
        ]
      }
    },
    { title: 'Value', field: 'value' },
  ],
});


        landmarkTable = new Tabulator('#landmark-table', {
          data: allLandmarks,
          layout: 'fitColumns',
          pagination: 'local',
          paginationSize: 10,
          columns: [
            { title: 'Participant ID', field: 'participantFileId' },
            {
              title: 'Landmark Name',
              field: 'landmarkName',
              headerFilter: dropdownMultiCheck,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: {
                values: [
                  "1st Point", "2nd Point", "Alar Base Junction/Alar Crease - left", "Alar Base Junction/Alar Crease - right",
                  "Alare/Alar Flare - left", "Alare/Alar Flare - right", "Alar Rim’s Highest Point - left", "Alar Rim’s Highest Point - right",
                  "Cervical Point", "Columellar Break Point", "Cheilion - left", "Cheilion - right", "Columellar Rim - left", "Columellar Rim - right",
                  "Corneal Plane", "Crista Philtri - left", "Crista Philtri - right", "Endocanthion/Medial Canthus - left", "Endocanthion/Medial Canthus - right",
                  "Exocanthion/Lateral Canthus - left", "Exocanthion/Lateral Canthus - right", "Glabella", "Soft tissue gonion - left", "Soft tissue gonion - right",
                  "Iris - left", "Iris - right", "Midpoint of left Infraorbital Rim", "Midpoint of right Infraorbital Rim",
                  "Posterior Point of Nostril - left", "Posterior Point of Nostril - right", "Kyphion", "Lateral helix of ear - left",
                  "Lateral helix of ear - right", "Labiale Inferius", "Labiale Superius", "Maxilloanteriorale - left", "Maxilloanteriorale - right",
                  "Menton/Gnathion", "Maxillofrontale - left", "Maxillofrontale - right", "Nasion/Radix", "Nasal Parenthesis - left",
                  "Nasal Parenthesis - right", "Pupil - left", "Pupil - right", "Pogonion", "Pronasale/Tip", "Rhinion", "Supratip Break Point",
                  "Subalare - left", "Subalare - right", "Sill-base junction - left", "Sill-base junction - right",
                  "Supratarsal Crease - left", "Supratarsal Crease - right", "Sellion", "Sublabiale/Mentolabial Sulcus", "Subnasale",
                  "Subnasale - left", "Subnasale - right", "Subspinale", "Anterior Point of Nostril/Columella Junction left",
                  "Anterior Point of Nostril/Columella Junction right", "Stomion", "Tragion - left", "Tragion - right",
                  "Tip Defining Point - left", "Tip Defining Point - right", "Trichion", "Vertex", "Zygion - left", "Zygion - right"
                ]
              }
            },
            { title: 'X Value', field: 'xVal' },
            { title: 'Y Value', field: 'yVal' },
            { title: 'Z Value', field: 'zVal' },
          ],
        });

        // ─────────────── INITIALIZE STATS TABLE ───────────────
        const statsTable = new Tabulator("#stats-table", {
          layout: "fitColumns",
          columns: [
            { title: "Name",           field: "Name" },
            { title: "Average",        field: "Average" },
            { title: "Std. Deviation", field: "StdDev" },
            { title: "Minimum",        field: "Min" },
            { title: "Maximum",        field: "Max" },
            { title: "Median",         field: "Median" },
          ],
        });
        // ────────────────────────────────────────────────────────


        // ─────────────── UTILITY FUNCTIONS ───────────────
        function mean(arr) {
          return arr.reduce((a, b) => a + b, 0) / arr.length;
        }
        function stdDev(arr) {
          const m = mean(arr);
          return Math.sqrt(arr.reduce((sum, x) => sum + (x - m) ** 2, 0) / arr.length);
        }
        function median(arr) {
          const s = arr.slice().sort((a, b) => a - b),
                mid = Math.floor(s.length / 2);
          return s.length % 2 ? s[mid] : (s[mid - 1] + s[mid]) / 2;
        }


        // ─────────────── UPDATE STATS ───────────────
        function updateStats() {

          const type = document.querySelector('input[name="statsType"]:checked').value;

          const table = (type === "measurements") ? measurementTable : landmarkTable;
          const rows = table.getData(true); // only filtered rows

          const groups = rows.reduce((acc, row) => {
            const name = (type === "measurements") ? row.measurementName : row.landmarkName;
            const val = parseFloat(
              type === "measurements"
                ? row.value
                : row.xVal || row.yVal || row.zVal
            );
            if (!acc[name]) acc[name] = [];
            if (!isNaN(val)) acc[name].push(val);
            return acc;
          }, {});

          const statsData = Object.entries(groups).map(([Name, vals]) => ({
            Name,
            Average: mean(vals).toFixed(2),
            StdDev: stdDev(vals).toFixed(2),
            Min: Math.min(...vals).toFixed(2),
            Max: Math.max(...vals).toFixed(2),
            Median: median(vals).toFixed(2),
          }));

          statsTable.replaceData(statsData);
        }

        // ────────────────────────────────────────────────

        // Handle "Show Stats" button click
        document.getElementById("show-stats-button").addEventListener("click", () => {
          updateStats(); // compute based on current filters + selected table
          document.getElementById("stats-table-container").style.display = "block";
        });



        participantsTable = new Tabulator('#participants-table', {
          data: participants,
          layout: 'fitColumns',
          pagination: 'local',
          paginationSize: 10,
          columns: [
            { title: 'Participant ID', field: 'participantFileId' },
            { title: 'Gender', field: 'Gender', headerFilter: dropdownMultiCheck, headerFilterFunc: multiSelectFilterFunc, headerFilterParams: { values: ['M','F','Other'] } },
            
            { title: 'Age Min', field: 'Age', sorter: 'number', headerFilter: 'input', headerFilterPlaceholder: 'Min…', headerFilterFunc: '>=', headerFilterLiveFilter: true },
            { title: 'Age Max', field: 'Age', sorter: 'number', headerFilter: 'input', headerFilterPlaceholder: 'Max…', headerFilterFunc: '<=', headerFilterLiveFilter: true  },

            { title: 'Ethnicity', field: 'Ethnicity', headerFilter: dropdownMultiCheck, headerFilterFunc: multiSelectFilterFunc, headerFilterParams: { values: ['White','Black or African American','American Indian or Alaska Native','Asian','Native Hawaiian or Other Pacific Islander','Hispanic','Prefer not to specify'] } },
            { title: 'Facial Surgery', field: 'FacialSurgery', headerFilter: dropdownMultiCheck, headerFilterFunc: multiSelectFilterFunc, headerFilterParams: { values: ['No Facial Surgery','Brow/forehead lift','Ear pinning','Chin, cheek, or jaw reshaping','Eyelid lift','Facelift','Facial implants','Hair replacement surgery','Lip augmentation','Rhinoplasty','Other','Prefer not to specify'] } },
          ],
        });


        ["age-min-input", "age-max-input"].forEach(id => {
          document.addEventListener('input', e => {
            if (e.target.id === id) {
              const chartVisible = document.getElementById("chart-container").style.display !== "none";
              const category = document.querySelector('input[name="category"]:checked')?.value;
              if (chartVisible && category === "Age") {
                drawChart();
              }
            }
          });
        });

        participantsTable.on('dataFiltered', (filters, rows) => {
          const ids = rows.map(r => r.getData().participantFileId);
          measurementTable.replaceData(allMeasurements.filter(m => ids.includes(m.participantFileId)));
          landmarkTable.replaceData(allLandmarks.filter(l => ids.includes(l.participantFileId)));

          if (document.getElementById("chart-container").style.display !== "none") {
            drawChart();
          }

          updateStats();
        });

        // Live updates from measurement & landmark tables
        measurementTable.on("dataFiltered", updateStats);
        measurementTable.on("dataChanged", updateStats);
        measurementTable.on("cellEdited", updateStats);

        landmarkTable.on("dataFiltered", updateStats);
        landmarkTable.on("dataChanged", updateStats);
        landmarkTable.on("cellEdited", updateStats);

        // Initial draw
        updateStats();



        document.getElementById('clearFilters').addEventListener('click', () => {
          participantsTable.clearHeaderFilter();
          measurementTable.clearHeaderFilter();
          landmarkTable.clearHeaderFilter();
        });
        })
        .catch(err => {
          console.error(err);
          document.querySelector('#participants-table').innerHTML = `<p style="color:red">${err}</p>`;
        });

        

    function downloadAllFilteredData() {
      const pd = participantsTable.getData("active"), ids=pd.map(p=>p.participantFileId);
      const md=measurementTable.getData().filter(m=>ids.includes(m.participantFileId));
      const ld=landmarkTable.getData().filter(l=>ids.includes(l.participantFileId));
      const makeSection=(data,title)=>{ if(!data.length) return''; const cols=Object.keys(data[0]); const rows=data.map(r=>cols.map(f=>`"${String(r[f]||'').replace(/"/g,'""')}"`).join(',')); return[`\n\n# ${title}`,cols.join(','),...rows].join('\n'); };
      const csv=[makeSection(pd,'Participants'),makeSection(md,'Measurements'),makeSection(ld,'Landmarks')].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='filtered_data.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    document.getElementById('downloadCSV').addEventListener('click', downloadAllFilteredData);



    // Show chart options + chart canvas and draw chart on button click
  document.getElementById('create-chart').addEventListener('click', () => {
    const chartContainer = document.getElementById('chart-container');
    chartContainer.style.display = 'grid';
    drawChart(); // draw the initial chart immediately
  });

  // Re-draw chart when chart options change
  document.getElementById('chart-options').addEventListener('change', () => {
    drawChart();
  });

  function drawChart() {
    const data = participantsTable.getData("active");

    if (!data.length) return;

    const category = document.querySelector('input[name="category"]:checked').value;
    const chartType = document.querySelector('input[name="chartType"]:checked').value;

    let labels = [];
    let values = [];

    if (category === 'Age') {
      const ageCounts = {};
      data.forEach(p => {
        const age = parseInt(p.Age);
        if (!isNaN(age)) {
          ageCounts[age] = (ageCounts[age] || 0) + 1;
        }
      });

      labels = Object.keys(ageCounts).sort((a, b) => a - b);
      values = labels.map(l => ageCounts[l]);
    } else {
      const counts = {};
      data.forEach(p => {
        const val = p[category] || 'Unknown';
        counts[val] = (counts[val] || 0) + 1;
      });

      labels = Object.keys(counts);
      values = labels.map(l => counts[l]);
    }

    const total = values.reduce((sum, val) => sum + val, 0) || 1;
    const percentages = values.map(val => (val / total * 100).toFixed(2));

    if (window.currentChart) {
      window.currentChart.destroy();
    }

    const ctx = document.getElementById('chart-canvas').getContext('2d');
    window.currentChart = new Chart(ctx, {
      type: chartType,
      data: {
        labels,
        datasets: [{
          label: '% of Participants',
          data: percentages,
          backgroundColor: labels.map((_, i) => `hsl(${i * 360 / labels.length}, 70%, 60%)`)
        }]
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: context => `${context.label}: ${context.formattedValue}%`
            }
          }
        }
      }
    });
  }









  </script>
</body>
</html>