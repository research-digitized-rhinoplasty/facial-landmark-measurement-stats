<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    #stats-table,
    #measurement-table {
      margin-top: 20px;
    }
    .button-row {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h2>3D Facial Landmark Query Tool</h2>

  <div class="button-row">
    <button id="clearFilters">Clear All Column Filters</button>
  </div>

  <!-- Stats Table -->
  <div id="stats-table"></div>

  <!-- Measurements Table -->
  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script>
    // Exact‐match helper for select filters
    function exactMatch(h, v) {
      return h === "All" || h === "Any" || v === h;
    }

    // 1) Custom multi‐select editor that toggles on click (no Ctrl needed)
    function multiSelectHeaderFilter(cell, onRendered, success, cancel, editorParams) {
      const select = document.createElement("select");
      select.multiple = true;
      select.size = 5;           // show 5 rows tall
      select.style.width = "100%";
      select.style.overflowY = "auto";

      // Populate options
      editorParams.values.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });

      onRendered(() => {
        // Prevent default (single‐select) behavior, toggle option
        select.addEventListener("mousedown", e => {
          e.preventDefault();
          if (e.target.tagName === "OPTION") {
            e.target.selected = !e.target.selected;
            const chosen = Array.from(select.selectedOptions).map(o => o.value);
            success(chosen);
          }
        });
      });

      return select;
    }

    // 2) Filter function: keep row if its value is in the chosen array
    function multiSelectFilterFunc(filterValues, cellValue) {
      if (!filterValues || filterValues.length === 0) return true;
      return filterValues.includes(cellValue);
    }

    // 3) Load data.json, build both tables
    fetch('data.json')
      .then(r => {
        if (!r.ok) throw new Error("data.json not found");
        return r.json();
      })
      .then(participants => {
        // Flatten all measurements
        const allMeasurements = participants.flatMap(p =>
          (p.ParticipantMeasurements || []).map(m => ({
            participantFileId: p.participantFileId,
            measurementName: m.MeasurementName,
            value: m.Value,
          }))
        );

        // Measurements table
        const measurementTable = new Tabulator("#measurement-table", {
          data: allMeasurements,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID",   field: "participantFileId" },
            { title: "Measurement Name", field: "measurementName" },
            { title: "Value",            field: "value" },
          ],
        });

        // Stats table
        const statsTable = new Tabulator("#stats-table", {
          data: participants,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID", field: "participantFileId" },

            // Gender multi‐select
            {
              title: "Gender",
              field: "Gender",
              headerFilter: multiSelectHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: { values: ["M","F","Other"] },
            },

            // Age Min / Max
            {
              title: "Age Min",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Min…",
              headerFilterFunc: ">=",
              headerFilterLiveFilter: true,
            },
            {
              title: "Age Max",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Max…",
              headerFilterFunc: "<=",
              headerFilterLiveFilter: true,
            },

            // Ethnicity multi‐select
            {
              title: "Ethnicity",
              field: "Ethnicity",
              headerFilter: multiSelectHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: {
                values: [
                  "White",
                  "Black or African American",
                  "American Indian or Alaska Native",
                  "Asian",
                  "Native Hawaiian or Other Pacific Islander",
                  "Hispanic",
                  "Prefer not to specify",
                ],
              },
            },

            // Facial Surgery multi‐select
            {
              title: "Facial Surgery",
              field: "FacialSurgery",
              headerFilter: multiSelectHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: {
                values: [
                  "No Facial Surgery",
                  "Brow/forehead lift",
                  "Ear Pinning",
                  "Chin, cheek, or jaw reshaping",
                  "Eyelid Lift",
                  "Facelift",
                  "Facial implants",
                  "Hair Replacement surgery",
                  "Lip Augmentation",
                  "Rhinoplasty",
                  "Other",
                  "Prefer not to specify",
                ],
              },
            },
          ],
        });

        // 4) Sync measurements when stats filters change
        statsTable.on("dataFiltered", (filters, rows) => {
          const ids = rows.map(r => r.getData().participantFileId);
          const filtered = allMeasurements.filter(m => ids.includes(m.participantFileId));
          measurementTable.replaceData(filtered);
        });

        // Clear button
        document.getElementById('clearFilters').addEventListener('click', () => {
          statsTable.clearHeaderFilter();
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('stats-table').innerHTML =
          `<p style="color:red;">${err.message}</p>`;
      });
  </script>
</body>
</html>
