<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet" />

  <style>
    body { font-family: Arial, padding: 20px; }
    #stats-table, #measurement-table { margin-top: 20px; }
    .button-row { margin: 10px 0; }
  </style>
</head>
<body>
  <h2>3D Facial Landmark Query Tool</h2>
  <div class="button-row">
    <button id="clearFilters">Clear All Column Filters</button>
  </div>

  <!-- Stats Table -->
  <div id="stats-table"></div>

  <!-- Measurements Table -->
  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script>
    // Helper for exact-match select filters:
    function exactMatch(headerValue, rowValue) {
      return headerValue === "All"
          || headerValue === "Any"
          || rowValue === headerValue;
    }

    fetch('data.json')
      .then(r => r.json())
      .then(participants => {
        // Flatten out every ParticipantMeasurements entry upfront:
        const allMeasurements = participants.flatMap(p =>
          (p.ParticipantMeasurements || []).map(m => ({
            participantFileId: p.participantFileId,
            measurementName: m.MeasurementName,
            value: m.Value,
          }))
        );

        // Build the Measurements table first (empty for now)
        const measurementTable = new Tabulator("#measurement-table", {
          data: allMeasurements,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID", field: "participantFileId" },
            { title: "Measurement Name", field: "measurementName" },
            { title: "Value", field: "value" },
          ],
        });

        // Build the Stats table
        const statsTable = new Tabulator("#stats-table", {
          data: participants,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID", field: "participantFileId" },

            {
              title: "Gender",
              field: "Gender",
              headerFilter: "select",
              headerFilterParams: { values: { All:"All", M:"M", F:"F", Other:"Other" } },
              headerFilterPlaceholder: "All",
              headerFilterFunc: exactMatch,
            },

            {
              title: "Age Min",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Min…",
              headerFilterFunc: ">=",
              headerFilterLiveFilter: true,
            },
            {
              title: "Age Max",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Max…",
              headerFilterFunc: "<=",
              headerFilterLiveFilter: true,
            },

            {
              title: "Ethnicity",
              field: "Ethnicity",
              headerFilter: "select",
              headerFilterParams: {
                values:{
                  All:"All",
                  White:"White",
                  "Black or African American":"Black or African American",
                  "American Indian or Alaska Native":"American Indian or Alaska Native",
                  Asian:"Asian",
                  "Native Hawaiian or Other Pacific Islander":"Native Hawaiian or Other Pacific Islander",
                  Hispanic:"Hispanic",
                  "Prefer not to specify":"Prefer not to specify"
                }
              },
              headerFilterPlaceholder: "All",
              headerFilterFunc: exactMatch,
            },

            {
              title: "Facial Surgery",
              field: "FacialSurgery",
              headerFilter: "select",
              headerFilterParams: {
                values:{
                  Any:"Any",
                  "No Facial Surgery":"No Facial Surgery",
                  "Brow/forehead lift":"Brow/forehead lift",
                  "Ear pinning":"Ear Pinning",
                  "Chin, cheek, or jaw reshaping":"Chin, cheek, or jaw reshaping",
                  "Eyelid lift":"Eyelid Lift",
                  Facelift:"Facelift",
                  "Facial implants":"Facial implants",
                  "Hair replacement surgery":"Hair Replacement surgery",
                  "Lip augmentation":"Lip Augmentation",
                  Rhinoplasty:"Rhinoplasty",
                  Other:"Other",
                  "Prefer not to specify":"Prefer not to specify"
                }
              },
              headerFilterPlaceholder: "Any",
              headerFilterFunc: exactMatch,
            },
          ],
        });

        // Whenever the Stats table data is filtered, rebuild the Measurements table
        statsTable.on("dataFiltered", (filters, rows) => {
          const visibleIDs = rows.map(r => r.getData().participantFileId);
          const filteredMeasurements = allMeasurements.filter(m =>
            visibleIDs.includes(m.participantFileId)
          );
          measurementTable.replaceData(filteredMeasurements);
        });

        // Wire up the clear button
        document.getElementById('clearFilters').addEventListener('click', () => {
          statsTable.clearHeaderFilter();
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('stats-table').innerHTML =
          `<p style="color:red">Error loading data.json: ${err.message}</p>`;
      });
  </script>
</body>
</html>
