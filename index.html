<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }
    #stats-table,
    #measurement-table {
      margin-top: 20px;
    }
    .button-row {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h2>3D Facial Landmark Query Tool</h2>

  <div class="button-row">
    <button id="clearFilters">Clear All Column Filters</button>
  </div>

  <!-- Stats Table -->
  <div id="stats-table"></div>

  <!-- Measurements Table -->
  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script>
    // === 1) Multi-select header editor ===
    function multiSelectHeaderFilter(cell, onRendered, success, cancel, editorParams) {
      // create <select multiple>
      const select = document.createElement("select");
      select.multiple = true;
      select.style.width = "100%";
      select.style.height = "100px";
      select.style.overflowY = "auto";

      // populate options
      editorParams.values.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });

      // when rendered, listen for changes
      onRendered(() => {
        select.addEventListener("change", () => {
          const chosen = Array.from(select.selectedOptions).map(o => o.value);
          success(chosen);
        });
      });

      return select;
    }

    // === 2) Filter function for multi-select ===
    function multiSelectFilterFunc(filterValues, cellValue) {
      // no selection = no filter
      if (!filterValues || filterValues.length === 0) return true;
      return filterValues.includes(cellValue);
    }

    // === 3) Load data.json and build tables ===
    fetch('data.json')
      .then(res => {
        if (!res.ok) throw new Error("data.json not found");
        return res.json();
      })
      .then(participants => {
        // flatten all ParticipantMeasurements for the measurements table
        const allMeasurements = participants.flatMap(p =>
          (p.ParticipantMeasurements || []).map(m => ({
            participantFileId: p.participantFileId,
            measurementName: m.MeasurementName,
            value: m.Value,
          }))
        );

        // --- Measurements Table (initially shows all) ---
        const measurementTable = new Tabulator("#measurement-table", {
          data: allMeasurements,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID",     field: "participantFileId" },
            { title: "Measurement Name",   field: "measurementName"   },
            { title: "Value",              field: "value"             },
          ],
        });

        // --- Stats Table with multi-select filters ---
        const statsTable = new Tabulator("#stats-table", {
          data: participants,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Participant ID", field: "participantFileId" },

            // Gender multi-select
            {
              title: "Gender",
              field: "Gender",
              headerFilter: multiSelectHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: { values: ["M","F","Other"] },
            },

            // Age Min
            {
              title: "Age Min",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Min…",
              headerFilterFunc: ">=",
              headerFilterLiveFilter: true,
            },
            // Age Max
            {
              title: "Age Max",
              field: "Age",
              sorter: "number",
              headerFilter: "input",
              headerFilterPlaceholder: "Max…",
              headerFilterFunc: "<=",
              headerFilterLiveFilter: true,
            },

            // Ethnicity multi-select
            {
              title: "Ethnicity",
              field: "Ethnicity",
              headerFilter: multiSelectHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: {
                values: [
                  "White",
                  "Black or African American",
                  "American Indian or Alaska Native",
                  "Asian",
                  "Native Hawaiian or Other Pacific Islander",
                  "Hispanic",
                  "Prefer not to specify"
                ]
              },
            },

            // Facial Surgery multi-select
            {
              title: "Facial Surgery",
              field: "FacialSurgery",
              headerFilter: multiSelectHeaderFilter,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams: {
                values: [
                  "No Facial Surgery",
                  "Brow/forehead lift",
                  "Ear Pinning",
                  "Chin, cheek, or jaw reshaping",
                  "Eyelid Lift",
                  "Facelift",
                  "Facial implants",
                  "Hair Replacement surgery",
                  "Lip Augmentation",
                  "Rhinoplasty",
                  "Other",
                  "Prefer not to specify"
                ]
              },
            },
          ],
        });

        // --- 4) Sync measurements on stats filter ---
        statsTable.on("dataFiltered", (filters, rows) => {
          const visibleIDs = rows.map(r => r.getData().participantFileId);
          const filtered = allMeasurements.filter(m =>
            visibleIDs.includes(m.participantFileId)
          );
          measurementTable.replaceData(filtered);
        });

        // --- 5) Clear button ---
        document.getElementById('clearFilters').addEventListener('click', () => {
          statsTable.clearHeaderFilter();
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('stats-table').innerHTML =
          `<p style="color:red;">Error loading data.json: ${err.message}</p>`;
      });
  </script>
</body>
</html>
