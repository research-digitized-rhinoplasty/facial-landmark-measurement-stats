<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Participant & Measurement Dashboard</title>
  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css"
    rel="stylesheet"
  />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 40px; }
    #participant-table, #measurement-table { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Participant & Measurement Dashboard</h1>

  <h2>Participants</h2>
  <div id="participant-table"></div>

  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
  <script>
    // Data holders
    let participantData = [];
    let measurementData = [];

    // 1) Participant table
    const participantTable = new Tabulator("#participant-table", {
      layout: "fitColumns",
      height: "300px",
      placeholder: "No participants to display",
      columns: [
        { title: "File ID",        field: "participantFileId", headerFilter: "input" },
        { title: "Gender",         field: "Gender",            headerFilter: "select",
          headerFilterParams: { "": "All", "F": "F", "M": "M" }
        },
        { title: "Age",            field: "Age",               headerFilter: "number" },
        { title: "Ethnicity",      field: "Ethnicity",         headerFilter: "input" },
        { title: "Facial Surgery", field: "FacialSurgery",     headerFilter: "input" },
      ],
      dataFiltered: function(filters, rows){
        // get visible participant IDs
        const ids = rows.map(r => r.getData().participantFileId);
        // filter measurements to those IDs
        const filtered = measurementData.filter(m =>
          ids.includes(m.participantFileId)
        );
        measurementTable.replaceData(filtered);
      },
    });

    // 2) Measurement table
    const measurementTable = new Tabulator("#measurement-table", {
      layout: "fitColumns",
      height: "300px",
      placeholder: "Filter participants to see measurements",
      columns: [
        { title: "File ID",          field: "participantFileId" },
        { title: "Measurement Name", field: "measurementName" },
        { title: "Value",            field: "value" },
      ],
    });

    // 3) Load data.json
    fetch("data.json")
      .then(res => res.json())
      .then(data => {
        // assume data.json is an array of participant objects
        participantData = data;
        participantTable.setData(participantData);

        // flatten out all ParticipantMeasurements
        measurementData = [];
        participantData.forEach(p => {
          if (Array.isArray(p.ParticipantMeasurements)) {
            p.ParticipantMeasurements.forEach(m => {
              measurementData.push({
                participantFileId: p.participantFileId,
                measurementName:   m.MeasurementName,
                value:             m.Value,
              });
            });
          }
        });
        // leave measurement table empty until you filter participants
      })
      .catch(err => console.error("Failed to load data.json:", err));
  </script>
</body>
</html>
