<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Tabulator CSS -->
  <link
    href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"
    rel="stylesheet"
  />

  <style>
    body { font-family: Arial; padding: 20px; }
    #participants-table,
    #measurement-table,
    #landmark-table,
    #stats-table { margin-top: 20px; }
    .button-row { margin: 10px 0; }

    /* Hide chart container until 'Chart' is clicked */
    #chart-container {
      display: none;
      margin: 0 auto;
      padding: 10px;
      max-width: 700px;
      text-align: center;
    }
    #chart-canvas { max-width: 100%; max-height: 400px; }

    /* Allow header filters to overflow */
    .tabulator .tabulator-header { overflow: visible !important; }
    .tabulator .tabulator-header .tabulator-col { overflow: visible !important; position: relative !important; }
    .tabulator .tabulator-header .tabulator-col .tabulator-header-filter { overflow: visible !important; position: relative !important; }

    /* Dropdown checkbox list styles */
    .checkbox-dropdown {
      position: absolute; top: 100%; left: 0; z-index: 9999;
      background: white; border: 1px solid #ccc;
      max-height: 180px; overflow-y: auto; padding: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .checkbox-dropdown label { display: block; font-size: 12px; cursor: pointer; margin-bottom: 2px; }
    .checkbox-dropdown input { margin-right: 6px; }
    .dropdown-toggle {
      cursor: pointer; padding: 4px; border: 1px solid #ccc;
      background: #fff; width: 100%; box-sizing: border-box;
    }

    /* Chart options styling */
    #chart-options { border: 1px solid #ccc; padding: 10px; max-width: 400px; }
    #chart-options label { margin-right: 10px; }
  </style>
</head>

<body>
  <h2>3D Facial Landmark Query Tool</h2>
  <div class="button-row">
    <button id="clearFilters">Clear All Filters</button>
    <button id="downloadCSV">Download Data</button>
    <button id="create-chart">Chart</button>
  </div>

  <h2>Participant Information</h2>
  <div id="participants-table"></div>

  <!-- Chart container hidden until Chart button clicked -->
  <div id="chart-container">
    <fieldset id="chart-options">
      <legend>Category</legend>
      <label><input type="radio" name="category" value="Ethnicity" checked> Ethnicity</label>
      <label><input type="radio" name="category" value="Gender"> Gender</label>
      <label><input type="radio" name="category" value="FacialSurgery"> Facial Surgery</label>
      <label><input type="radio" name="category" value="Age"> Age</label>
      <br><br>
      <label><input type="radio" name="chartType" value="pie" checked> Pie</label>
      <label><input type="radio" name="chartType" value="bar"> Bar</label>
    </fieldset>
    <canvas id="chart-canvas"></canvas>
  </div>

  <h2>Measurements</h2>
  <div id="measurement-table"></div>

  <h2>Landmarks</h2>
  <div id="landmark-table"></div>

  <!-- ── STATISTICS CONTROLS & TABLE ── -->
  <div style="margin:1em 0">
    <label for="statsType"><strong>Show stats for:</strong></label>
    <select id="statsType">
      <option value="measurements">Measurements</option>
      <option value="landmarks">Landmarks</option>
    </select>
  </div>
  <div id="stats-table"></div>
  <!-- ──────────────────────────────────── -->

  <!-- Libraries -->
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ───────────────── FILTER HELPERS ─────────────────
    function exactMatch(h,v){ return h==="All"||h==="Any"||v===h; }

    function dropdownMultiCheck(cell, onRendered, success){
      const col    = cell.getColumn(),
            field  = col.getField(),
            table  = cell.getTable(),
            values = col.getDefinition().headerFilterParams.values;

      const toggle = document.createElement('div');
      toggle.classList.add('dropdown-toggle');

      function updateLabel(){
        const cur = table.getHeaderFilterValue(field)||[];
        toggle.textContent = cur.length ? cur.join(', ') : 'Select...';
      }
      updateLabel();

      let list;
      function openDropdown(){
        if(list) return;
        list = document.createElement('div');
        list.classList.add('checkbox-dropdown');

        const cur = table.getHeaderFilterValue(field)||[];
        values.forEach(val => {
          const lbl = document.createElement('label');
          const cb  = document.createElement('input');
          cb.type    = 'checkbox';
          cb.value   = val;
          cb.checked = cur.includes(val);
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(val));
          list.appendChild(lbl);

          cb.addEventListener('change',()=>{
            const chosen = Array.from(
              list.querySelectorAll('input:checked')
            ).map(i=>i.value);
            success(chosen);
            toggle.textContent = chosen.length? chosen.join(', '): 'Select...';

            // redraw stats/chart if needed
            updateStats();
            const cat = document.querySelector('input[name="category"]:checked').value;
            if(
              document.getElementById('chart-container').style.display!=='none' &&
              ((cat==='Age' && field==='Age') || field.toLowerCase().includes(cat.toLowerCase()))
            ){
              drawChart();
            }
          });
        });

        document.body.appendChild(list);
        const r = toggle.getBoundingClientRect();
        list.style.top  = r.bottom + window.scrollY + 'px';
        list.style.left = r.left   + window.scrollX + 'px';
        document.addEventListener('click', outsideClick);
      }

      function closeDropdown(){
        if(list){ list.remove(); list=null; }
        document.removeEventListener('click', outsideClick);
      }

      function outsideClick(e){
        if(!toggle.contains(e.target) && list && !list.contains(e.target)){
          closeDropdown();
        }
      }

      toggle.addEventListener('click', e=>{
        e.stopPropagation();
        list? closeDropdown(): openDropdown();
      });

      onRendered(()=>{});
      return toggle;
    }

    function multiSelectFilterFunc(filterVals, cellVal){
      if(!filterVals || !filterVals.length) return true;
      return filterVals.includes(cellVal);
    }
    // ──────────────────────────────────────────────────

    let participantsTable,
        measurementTable,
        landmarkTable,
        statsTable,
        currentChart;

    // ────────── FETCH DATA & INITIALIZE TABLES ──────────
    fetch('data.json')
      .then(r=> r.ok ? r.json() : Promise.reject('data.json not found'))
      .then(participants=>{

        // flatten for measures/landmarks
        const allMeasurements = participants.flatMap(p=>
          (p.ParticipantMeasurements||[]).map(m=>({
            participantFileId: p.participantFileId,
            measurementName:   m.MeasurementName,
            value:             m.Value
          }))
        );
        const allLandmarks = participants.flatMap(p=>
          (p.ParticipantLandmarks||[]).map(l=>({
            participantFileId: p.participantFileId,
            landmarkName:      l.LandmarkName,
            xVal:              l.xVal,
            yVal:              l.yVal,
            zVal:              l.zVal
          }))
        );

        // 1) PARTICIPANTS
        participantsTable = new Tabulator('#participants-table',{
          data: participants,
          layout:'fitColumns',
          pagination:'local',
          paginationSize:10,
          columns:[
            { title:'Participant ID', field:'participantFileId' },
            { title:'Gender', field:'Gender',
              headerFilter: dropdownMultiCheck,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams:{ values:['M','F','Other'] }
            },
            { title:'Age Min', field:'Age', sorter:'number',
              headerFilter:'input', headerFilterPlaceholder:'Min…',
              headerFilterFunc:'>=', headerFilterLiveFilter:true
            },
            { title:'Age Max', field:'Age', sorter:'number',
              headerFilter:'input', headerFilterPlaceholder:'Max…',
              headerFilterFunc:'<=', headerFilterLiveFilter:true
            },
            { title:'Ethnicity', field:'Ethnicity',
              headerFilter: dropdownMultiCheck,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams:{
                values:[
                  'White','Black or African American',
                  'American Indian or Alaska Native',
                  'Asian','Native Hawaiian or Other Pacific Islander',
                  'Hispanic','Prefer not to specify'
                ]
              }
            },
            { title:'Facial Surgery', field:'FacialSurgery',
              headerFilter: dropdownMultiCheck,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams:{
                values:[
                  'No Facial Surgery','Brow/forehead lift','Ear pinning',
                  'Chin, cheek, or jaw reshaping','Eyelid lift','Facelift',
                  'Facial implants','Hair replacement surgery','Lip augmentation',
                  'Rhinoplasty','Other','Prefer not to specify'
                ]
              }
            },
          ],
        });

        // sync child tables & stats on participants filter
        participantsTable.on('dataFiltered',(_f,rows)=>{
          const ids = rows.map(r=>r.getData().participantFileId);
          measurementTable.replaceData(
            allMeasurements.filter(m=>ids.includes(m.participantFileId))
          );
          landmarkTable.replaceData(
            allLandmarks.filter(l=>ids.includes(l.participantFileId))
          );
          updateStats();
          if(document.getElementById('chart-container').style.display!=='none'){
            drawChart();
          }
        });

        // 2) MEASUREMENT
        measurementTable = new Tabulator('#measurement-table',{
          data: allMeasurements,
          layout:'fitColumns',
          pagination:'local',
          paginationSize:10,
          columns:[
            { title:'Participant ID', field:'participantFileId' },
            {
              title:'Measurement Name', field:'measurementName',
              headerFilter: dropdownMultiCheck,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams:{
                values:[
                  "(Inner) Intercanthal Distance/Width","Ala/Alar Length (left)",
                  "Ala/Alar Length (right)","Alar Base Width","Base Bony Width",
                  "Columella Length","Columella Width",
                  /* … all your other measurement names … */
                  "Tip Volume","Volume between the vertical fifths and horizontal thirds"
                ]
              }
            },
            { title:'Value', field:'value' },
          ],
        });

        // 3) LANDMARK
        landmarkTable = new Tabulator('#landmark-table',{
          data: allLandmarks,
          layout:'fitColumns',
          pagination:'local',
          paginationSize:10,
          columns:[
            { title:'Participant ID', field:'participantFileId' },
            {
              title:'Landmark Name', field:'landmarkName',
              headerFilter: dropdownMultiCheck,
              headerFilterFunc: multiSelectFilterFunc,
              headerFilterParams:{
                values:[
                  "1st Point","2nd Point","Alar Base Junction/Alar Crease - left",
                  /* … all your other landmark names … */
                  "Zygion - right"
                ]
              }
            },
            { title:'X Value', field:'xVal' },
            { title:'Y Value', field:'yVal' },
            { title:'Z Value', field:'zVal' },
          ],
        });

        // 4) STATS TABLE
        statsTable = new Tabulator('#stats-table',{
          layout:'fitColumns',
          columns:[
            { title:'Name',           field:'Name' },
            { title:'Average',        field:'Average' },
            { title:'Std. Deviation', field:'StdDev' },
            { title:'Minimum',        field:'Min' },
            { title:'Maximum',        field:'Max' },
            { title:'Median',         field:'Median' },
          ],
        });

        // 5) STAT HELPERS & UPDATER
        function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length }
        function stdDev(arr){
          const m=mean(arr);
          return Math.sqrt(arr.reduce((s,x)=>s+(x-m)**2,0)/arr.length);
        }
        function median(arr){
          const s=arr.slice().sort((a,b)=>a-b),
                mid=Math.floor(s.length/2);
          return s.length%2? s[mid]: (s[mid-1]+s[mid])/2;
        }

        function updateStats(){
          const type  = document.getElementById('statsType').value;
          const table = type==='measurements'? measurementTable: landmarkTable;
          const rows  = table.getData(true); // <-- only filtered rows

          const groups = rows.reduce((acc,row)=>{
            const name = type==='measurements'
              ? row.measurementName
              : row.landmarkName;
            const val = parseFloat(
              type==='measurements'? row.value: row.xVal
            );
            if(!acc[name]) acc[name]=[];
            if(!isNaN(val)) acc[name].push(val);
            return acc;
          },{});

          const statsData = Object.entries(groups).map(([Name,vals])=>({
            Name,
            Average: mean(vals).toFixed(2),
            StdDev:  stdDev(vals).toFixed(2),
            Min:     Math.min(...vals).toFixed(2),
            Max:     Math.max(...vals).toFixed(2),
            Median:  median(vals).toFixed(2),
          }));

          statsTable.replaceData(statsData);
        }

        // 6) WIRE UP STATS REFRESH & CLEAR
        document.getElementById('statsType')
                .addEventListener('change', updateStats);
        measurementTable.on('dataFiltered', updateStats);
        landmarkTable .on('dataFiltered', updateStats);

        document.getElementById('clearFilters')
                .addEventListener('click', ()=>{
          participantsTable.clearHeaderFilter();
          measurementTable.clearHeaderFilter();
          landmarkTable.clearHeaderFilter();
        });

        // 7) INITIAL DRAW
        updateStats();

      }) // end .then
      .catch(err=>{
        console.error(err);
        document.querySelector('#participants-table').innerHTML =
          `<p style="color:red">${err}</p>`;
      });

    // ───── DOWNLOAD & CHART HANDLERS ─────
    function downloadAllFilteredData(){
      const pd = participantsTable.getData('active'),
            ids= pd.map(p=>p.participantFileId),
            md = measurementTable.getData().filter(m=>ids.includes(m.participantFileId)),
            ld = landmarkTable.getData().filter(l=>ids.includes(l.participantFileId));

      const makeSection=(data,title)=>{
        if(!data.length) return '';
        const cols = Object.keys(data[0]);
        const rows = data.map(r=> cols.map(f=>`"${String(r[f]||'').replace(/"/g,'""')}"`).join(','));
        return ['\n\n# '+title, cols.join(','), ...rows].join('\n');
      };

      const csv = makeSection(pd,'Participants')
                + makeSection(md,'Measurements')
                + makeSection(ld,'Landmarks');

      const blob = new Blob([csv],{ type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href    = URL.createObjectURL(blob);
      link.download= 'filtered_data.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    document.getElementById('downloadCSV')
            .addEventListener('click', downloadAllFilteredData);

    document.getElementById('create-chart')
            .addEventListener('click', ()=>{
      document.getElementById('chart-container').style.display='grid';
      drawChart();
    });
    document.getElementById('chart-options')
            .addEventListener('change', drawChart);

    function drawChart(){
      const data = participantsTable.getData('active');
      if(!data.length) return;

      const category = document.querySelector('input[name="category"]:checked').value;
      const chartType= document.querySelector('input[name="chartType"]:checked').value;

      let labels=[], values=[];
      if(category==='Age'){
        const ageCounts={};
        data.forEach(p=>{
          const a = parseInt(p.Age);
          if(!isNaN(a)) ageCounts[a]=(ageCounts[a]||0)+1;
        });
        labels = Object.keys(ageCounts).sort((a,b)=>a-b);
        values = labels.map(l=>ageCounts[l]);
      } else {
        const counts={};
        data.forEach(p=>{
          const v = p[category]||'Unknown';
          counts[v] = (counts[v]||0)+1;
        });
        labels = Object.keys(counts);
        values = labels.map(l=>counts[l]);
      }

      const total = values.reduce((s,v)=>s+v,0)||1;
      const perc  = values.map(v=>(v/total*100).toFixed(2));

      if(window.currentChart) window.currentChart.destroy();
      const ctx = document.getElementById('chart-canvas').getContext('2d');
      window.currentChart = new Chart(ctx,{
        type: chartType,
        data: {
          labels,
          datasets: [{
            label: '% of Participants',
            data: perc,
            backgroundColor: labels.map((_,i)=>`hsl(${i*360/labels.length},70%,60%)`)
          }]
        },
        options:{
          responsive:true,
          plugins:{ tooltip:{ callbacks:{ label:c=>`${c.label}: ${c.formattedValue}%` } } }
        }
      });
    }
  </script>
</body>
</html>
