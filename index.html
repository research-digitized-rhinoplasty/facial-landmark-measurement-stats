<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Facial Landmark Query Tool</title>

  <!-- Choices.js CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    rel="stylesheet"
  />

  <style>
    body { font-family: Arial; padding: 20px; }
    .filter-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1rem;
      margin-bottom: 20px;
    }
    label {
      display: flex;
      flex-direction: column;
      font-weight: bold;
    }
    select, input {
      padding: 8px;
      font-size: 14px;
    }
    #results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    #results-table th,
    #results-table td {
      border: 1px solid #666;
      padding: 6px;
      text-align: left;
      cursor: pointer;
    }
    #results-table th {
      background: #eee;
    }
    #results-table th.sorted-asc::after  { content: " ▲"; }
    #results-table th.sorted-desc::after { content: " ▼"; }
  </style>
</head>

<body>
  <h2>3D Facial Landmark Query Tool</h2>

  <div class="filter-row">
    <label>Gender
      <select id="genderFilter" multiple>
        <option value="All">All</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Prefer Not To Say">Prefer Not To Say</option>
        <option value="Other">Other</option>
      </select>
    </label>

    <label>Ethnicity
      <select id="ethnicityFilter" multiple>
        <option value="All">All</option>
        <option value="White">White</option>
        <option value="Black or African American">Black or African American</option>
        <option value="American Indian or Alaska Native">American Indian or Alaska Native</option>
        <option value="Asian">Asian</option>
        <option value="Native Hawaiian or Other Pacific Islander">Native Hawaiian or Other Pacific Islander</option>
        <option value="Hispanic">Hispanic</option>
      </select>
    </label>

    <label>Facial Surgery
      <select id="surgeryFilter" multiple>
        <option value="Any">Any</option>
        <option value="No Facial Surgery">No Facial Surgery</option>
        <option value="Brow/forehead lift">Brow/forehead lift</option>
        <option value="Ear pinning">Ear pinning</option>
        <option value="Chin, cheek, or jaw reshaping">Chin, cheek, or jaw reshaping</option>
        <option value="Eyelid lift">Eyelid lift</option>
        <option value="Facelift">Facelift</option>
        <option value="Facial implants">Facial implants</option>
        <option value="Hair replacement surgery">Hair replacement surgery</option>
        <option value="Lip augmentation">Lip augmentation</option>
        <option value="Rhinoplasty">Rhinoplasty</option>
        <option value="Other">Other</option>
        <option value="Prefer not to specify">Prefer not to specify</option>
      </select>
    </label>

    <label>Age Start
      <input type="number" id="ageMin" placeholder="Min Age" />
    </label>

    <label>Age End
      <input type="number" id="ageMax" placeholder="Max Age" />
    </label>
  </div>

  <div style="margin-bottom: 16px;">
    <button id="applyBtn">Apply Filters</button>
    <button id="clearBtn">Clear</button>
  </div>

  <h3>Filtered Results</h3>
  <table id="results-table">
    <thead>
      <tr>
        <th data-field="participantFileId">Participant ID</th>
        <th data-field="Gender">Gender</th>
        <th data-field="Age">Age</th>
        <th data-field="Ethnicity">Ethnicity</th>
        <th data-field="FacialSurgery">Facial Surgery</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Choices.js & our script -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    let originalData = [];
    let displayData  = [];
    const sortState  = {};

    // 1) Initialize Choices.js on your selects
    const genderChoices    = new Choices('#genderFilter',    { removeItemButton: true });
    const ethnicityChoices = new Choices('#ethnicityFilter', { removeItemButton: true });
    const surgeryChoices   = new Choices('#surgeryFilter',   { removeItemButton: true });

    // 2) Helper to render rows
    function renderTable(rows) {
      displayData = rows.slice();
      const tbody = document.querySelector('#results-table tbody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.participantFileId}</td>
          <td>${r.Gender}</td>
          <td>${r.Age}</td>
          <td>${r.Ethnicity}</td>
          <td>${r.FacialSurgery}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 3) Load data.json
    fetch('data.json')
      .then(r => r.json())
      .then(data => {
        originalData = data;
        renderTable(data);
      })
      .catch(e => console.error('Could not load data.json:', e));

    // 4) Apply filter logic
    document.getElementById('applyBtn').addEventListener('click', () => {
      const selG = genderChoices.getValue(true);
      const selE = ethnicityChoices.getValue(true);
      const selS = surgeryChoices.getValue(true);
      const minA = parseInt(document.getElementById('ageMin').value);
      const maxA = parseInt(document.getElementById('ageMax').value);

      // map Male/Female → M/F
      const genders = selG.includes('All')
        ? []
        : selG.map(v => v === 'Male' ? 'M' : v === 'Female' ? 'F' : v);

      const ethnicities = selE.includes('All') ? [] : selE;
      const surgeries   = selS.includes('Any') ? [] : selS;

      const filtered = originalData.filter(r => {
        const age = parseInt(r.Age);
        return (
          (genders.length === 0     || genders.includes(r.Gender))        &&
          (ethnicities.length === 0 || ethnicities.includes(r.Ethnicity)) &&
          (surgeries.length === 0   || surgeries.includes(r.FacialSurgery)) &&
          (isNaN(minA) || age >= minA) &&
          (isNaN(maxA) || age <= maxA)
        );
      });

      renderTable(filtered);
    });

    // 5) Clear filters
    document.getElementById('clearBtn').addEventListener('click', () => {
      genderChoices.removeActiveItems();
      ethnicityChoices.removeActiveItems();
      surgeryChoices.removeActiveItems();
      document.getElementById('ageMin').value = '';
      document.getElementById('ageMax').value = '';
      renderTable(originalData);

      // reset sorting UI
      document.querySelectorAll('#results-table th')
        .forEach(th => th.classList.remove('sorted-asc','sorted-desc'));
      Object.keys(sortState).forEach(f => delete sortState[f]);
    });

    // 6) Sorting on header click
    document.querySelectorAll('#results-table th').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.field;
        const current = sortState[field] || 'none';
        const next = current === 'asc' ? 'desc' : 'asc';
        sortState[field] = next;

        // update header arrows
        document.querySelectorAll('#results-table th')
          .forEach(h => h.classList.remove('sorted-asc','sorted-desc'));
        th.classList.add(next === 'asc' ? 'sorted-asc':'sorted-desc');

        // sort and re-render
        displayData.sort((a,b) => {
          let va = a[field], vb = b[field];
          const na = parseFloat(va), nb = parseFloat(vb);
          if (!isNaN(na) && !isNaN(nb)) {
            va = na; vb = nb;
          } else {
            va = va.toString().toLowerCase();
            vb = vb.toString().toLowerCase();
          }
          if (va<vb) return next==='asc'?-1:1;
          if (va>vb) return next==='asc'?1:-1;
          return 0;
        });
        renderTable(displayData);
      });
    });
  });
  </script>
</body>
</html>
